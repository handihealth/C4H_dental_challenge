#NHS Code4Health Dental App Challenge

##Introduction

At the NHS Open Source Open Day to be held in Newcastle on 26th November it was proposed to run an 'on-the-day' app hack to showcase the HANDI-HOPD Open Platform Demonstrator. 

A vote was held via the [NHS Open Source programme](http://www.technologystrategy.england.nhs.uk/pg/groups/99205/) and the winner was a proposal to create an app supporting the Community Dental Service team in Northumbria, monitoring the dental health of children as part of a Safeguarding Children initiative.

A number of software development teams have offered their assistance on the 26th but since time will be extremely short on the day, this site will make a number of documents and other resources avaiable as a gentle heads-up.

The scenario and related application may seem simple but actually captures some fairly complex data including SNOMED coded items, counts, ordinals and is aligned with the the [RCP/AoMRC outpatient clinical headings](https://www.rcplondon.ac.uk/sites/default/files/standards-for-the-clinical-structure-and-content-of-patient-records.pdf). 

One of the key challenges for the hack teams will be to persist the collected information to the HANDI-HOPD platform via the openEHR Ehrscape API. This API will be unfamiliar to most of the teams involved, though some have had limited experience of working with openEHR data.

We also hope to be able to demonstrate the vendor-neutral aspect of openEHR by saving and retrieving the document to several openEHR servers, each working on completely different technical stacks.


##The Dental App Challenge Scenario

Community dental services (CDS) provide dental care for people unable to access care from high street dentists. This includes vulnerable children. Dental decay is a common finding in cases of child neglect. Effective communication between community dentists and school nurses will help identify children who are suffering neglect.

Current problem: In Northumbria CDS we use paper based clinical records and to share dental information with school nurses about a vulnerable child requires a [letter] to be generated by the dentist, saved as PDF and sent via email. Last month 9.5 days of dentist's time was spent writing these letters. We also want incorporate aspects of the [Dental Health Risk score app (RAG)](https://github.com/openGPSoC/dental_RAG-score) that was built at a recent NHS Hackday.

###Scenario objectives

1. Populate the Patient Demographics via a FHIR-like Patient API provided by Neovahealth / Black Pear software
2. Create the Dental Assessment data entry form
3. Persist the completed Dental Assessment data entry form to the HANDI-HOPD platform (Ehrscape API)
4. Create a service which transforms the persisted document to a PDF for attachment to an email.
5. Re-persist the openEHR document to other openEHR vendor servers (OceanEHR, Code24, Cabolabs).

It is expected that most hack teams will concentrate on items 1,2,3.   
We have identified a team who are happy to concentrate on items 4 and 5.

###What has been pre-prepared
To ensure that the app challenge can progress rapidly, a small number of assets have been pre-prepared...

*   openEHR archetypes and 'Dental Assessment Final Report' template, defining the target dataset 'schema'
*   openEHR Dental Assessment Final Report' instance data examples matching the target dataset schema
*   A minimal Prototype Dental Assesment data entry web app

###The prototype Dental Assessment data entry web app
 A [simple prototype app](http://c4hdental-handihopd.rhcloud.com/) with [source code on GitHub.](https://github.com/handihealth/C4H_dental_challenge) has been provided to help clarify the clinical requirements and the RAG Risk score algorithm, but does not include any integration with demographics or Ehrscape APIs. Hack teams are, of course, welcome to create a very different UI. 

 The key challenge for hack teams is to map the data fields into a target openEHR JSON string (to be provided). That string is then passed to the Ehrscape API for persistence.

####Key openEHR datatypes
openEHR has a very rich set of allowable datatypes. A full defiinition is beyond the scope of this document but developers new to this field may find the follwoing notes helpful.

*  **'text'** allows the recording of simple,unformatted text. openEHR does not normally constrain the length of string.
 
*  **'codedText'** is a commonly used datatype in openEHR systems and is a sub-class of text. i.e where-ever text is specified codedText can be used instead. 
  
  Codes may be 'external' e.g. SNOMED CT or 'local', where they are defined within archetypes and have the form 'atxxxxx'.   

  A codedText element always includes the terminologyID, the code itself and the text of the coded concept (Rubric).  
  Where a codedText item is required, allowed value(s) are expressed in the form:  

	terminologyId::code::rubric
	
	e.g. local::at0007::Dental swelling
	
	     SNOMED-CT::123456::No pathology found

*  **'ordinal'** is a datatype which combines codedText with a score, expressed as an integer.  
   
   *  0: Green  `local::at0022::Green`    
   *  1: Amber  `local::at0023::Amber`   
   *  2: Red    `local::at0024::Red`
		 	    
*  **'count'** is a simple integer.  

*  **'dateTime'** records a date or date and time using the [ISO8061 format](http://www.w3.org/TR/NOTE-datetime).
 
###The Dental Assessment dataset 
The dataset for the Dental Assessment form is defined as an 'openEHR template'. This is assembled  from a number of open source component 'archetypes' e.g. 'Symptom', 'Physical Examination' etc. These are brought together into a 'template' and further constrained to fit the Dental Assessment use-case.

####'Assessed by' section
**Dentist name:** `datatype=text`  
**Clinic address:** `datatype=text`  
**Date assessed:** `datatype=date (Use ISO 8061 format e.g. 2005-10-18T00:00:00.000+02:00)`  

####Primary School section
**Primary school contact name (person):** `datatype=text`  
**Contact details phone, email etc:** `datatype=text`   
**Name of school:** `datatype=text`  

####History Section
**Dental pain symptom:** `datatype=codedText: "SNOMED-CT::102616008::Painful mouth" (only include code if Dental pain symptom is present).`

####Examination Findings Section
**Number of teeth with decay (0-32):** `datatype=count:0-32 (integer)`  

**Dental swelling:** `datatype=codedText`  
  
* Dental swelling present `local::at0005::Dental swelling present`   
* Dental swelling absent  `local::at0006::Dental swelling absent` 
	 
**Plaque control:**  `datatype=codedText`  

* Good plaque control `local:at00002::Good plaque control` 
* Poor plaque control `local::at0003::Poor plaque control`  
 
####Radiology Findings section
*Either*  

  **No problems detected:** `datatype=codedText: SNOMED-CT::23875004:No diagnostic abnormality`    

*or* 
   
  **Number of teeth with decay (0-32):** `datatype=count:0-32 (integer)`   
  **Teeth with abscess (0-32):**`datatype=count:0-32 (integer)`  
 
####Dental RAG Score section
For this application only the Caries (Tooth decay) aspect of the original RAG score is required.  

**Clinical Factors:** `datatype=codedText (internal code)`  

* Teeth with carious lesions `local::at0025::Teeth with carious lesions` 
* No teeth with carious lessions `local::at0026::No teeth with carious lesions`  

**Patient Factors:**  `datatype=codedText [0..*] (multiple internal codes)`  

 *  Symptoms `local::at0027::Symptoms`  
 *  Diet - Excess sugar / frequent sugar `local::at0028::Diet - Excess sugar / frequent sugar`   
 *  Unsatisfactory Plaque control `local::at0029::Unsatisfactory Plaque control`  
 *  Sibling experience `local::at0030::Sibling experience`  
 
**Risk Score:** `ordinal` 

The score (Green | Amber | Red) for each RAG section is captured as an ordinal i.e. a codedText with an associated integer. 

*  0 Green `local::at0022::Green`  
*  1 Amber `local::at0023::Amber`  
*  2 Red   `local::at0024::Red`  
 
####Treatment planned section
**Treatment planned :** `text [0..*]`  

####Follow-up arrangements section
**Follow-up arrangements:** `text [0..*]`  

####Summary section
**Follow-up arrangements:** `text [0..*]`  


##Technical objectives

###A. Retrieve Patient Demographics

Retreive First name, Last Name, Address, Date of Birth, NHS Number, Gender.

The API will follow the FHIR Patient resource very closely and is likely to be of the form:

    GET {{baseurl}}/patient/?identifer={{nhsNumber}} where nhsNumber=7430345

Two FHIR demographics servers are available

*  [BlackPear FHIRBall server](https://pyruscloud.blackpear.com/fhir/Patient?identifier=7430345)  
*  [NeovaHealth FHIR-like server](http://nhsdemo.openeobs.net/api/v1/patient?identifier=7430345) (needs Basic Authentication: login=fhir_api pwd=fhir_api))

This will return a FHIR JSON string aligned with the [FHIR Patient resource.](http://hl7-fhir.github.io/patient.html).

e.g. [FHIR JSON Patient Example](https://github.com/handihealth/C4H_dental_challenge/blob/master/technical/instances/fhir%20child%20female.json)

Note that these severs currently return slightly different formats. This is expected to be resolved as part of the App challenge, or possibly in advance.

###B. Develop Dental Assessment form 

Hack teams are free to develop the Dental Assessment data entry form in any way they choose, so long as the key requirements are met. We expect a number of community dental stakeholders to be on-hand to offer advice and feedback. The prime objective is to be able ot share the data collected in an interoperable format.

Tablet or desktop formats are probably more appropriate to this use-case than phone formats.

###C. Persist the Dental Assessment Form as openEHR via HANDI-HOPD Ehrscape

All openEHR data is persisted as a COMPOSITION class. openEHR data can be highly structured and potentially complex. To simplify the challenge of persisting openEHR data, examples of Dental Assessment 'target composition' data instanceshave been provided in different formats. HANDI-HOPD EhrScape will accept any of these formats and the data is in each example is persisted identically. Other openEHR servers such as OceanEHR, Code24 and Cabolabs currently only support the RAW XML format.

Once the data is assembled in the correct format, the actual service call is very simple requiring only the setting of simple paramters and headers.

**Example openEHR target Composition Documents**

[Structured JSON](https://github.com/handihealth/C4H_dental_challenge/blob/master/technical/instances/AoMRC%20Community%20Dental%20Assessment%20STRUCTURED.json)
[Flat JSON](https://github.com/handihealth/C4H_dental_challenge/blob/master/technical/instances/AoMRC%20Community%20Dental%20Assessment%20FLAT.json)
[Raw XML](https://github.com/handihealth/C4H_dental_challenge/blob/master/technical/instances/AoMRC%20Community%20Dental%20Assessment%20 RAW.xml)

A typical CURL to persist FLAT JSON is ..

 
###D. Create a web service to retrieve the stored openEHR composition,  transform to PDF

Once the openEHr composition is stored, a separate service should retrieve the document, transform it to a PDF with a format similar to the [example Dental Assessment Letters](https://github.com/handihealth/C4H_dental_challenge/tree/master/docs), then attach to an email.


###E. Re-persist the composition to other openEHR servers

Several openEHR server vendors are working to emulate the key aspects of the Marand Ehrscape API so that it should be possible to demonstrate that these can consume and retrieve properly formatted openEHR canonical XML data.

Appropriate APIs will be provided but these should match the [EhrScape composition APIs](https://www.ehrscape.com/api-explorer.html), other than having a different baseUrl. Only XML RAW format is supported.


#openEHR and HANDI-HOPD Ehrscape

The [HANDI-HOPD Ehrscape API](https://www.ehrscape.com/api-explorer.html), developed by Marand, provides a simple restful API which hides much of the complexity of the underlying openEHR server. In particular it accepts simpler, flatter forms of data, using defaults within the template schema to correctly populate the canonical openEHR data which is actually stored internally.

e.g. If working with an internal codedText value in the FLAT JSON format,it is only necessary to provide the local code, the terminologyId and Rubric being derived from the accompanying template.

    FLAT JSON
		 ... "community_dental_final_assessment_letter/assessment_scales/dental_rag_score:0/caries_tooth_decay/clinical_factors|code": "at0025", ...
		 
    STRUCTURED JSON
     ... "clinical_factors": [
       {
        "|code": "at0025",
        "|terminology": "local",
        "|value": "Teeth with carious lesions"
      }
      ]	...
			
		RAW XML
		... <ns2:value xsi:type="ns2:DV_CODED_TEXT">
		        <ns2:value>Teeth with carious lesions</ns2:value>
		            <ns2:defining_code>
			            <ns2:terminology_id>
			 	            <ns2:value>local</ns2:value>
			           </ns2:terminology_id>
			           <ns2:code_string>at0025</ns2:code_string>
		           </ns2:defining_code>
	         </ns2:value>
       </ns2:value> ...			 


###Handling specific datatypes

**text**

**codedText**

**ordinal**

**date**

**Multiple occurrence data**


### Reference model attributes

A number of key data points need to be populated in an openEHR composition, which may not be appraent from the archetypes or templates. Developers can largely use the example instance documents and APIs for guidance but these notes may give useful background. Links are given to a UML representation ofthe openEHR documentation.

    API attributes
		commiter
    committerId

    COMPOSITION attributes
		composer
    composerId

    starttime

    healthcare_facility

    OBSERVATION attributes
		
		/time

    ACTION attributes
		
		/time


The Ehrscape FLAT and STRUCTURED formats hide much of the complexity of these attributes, providing sensible defaults.
In particular the `ctx` header common to both JSON STRUCTURED and FLAT formats, considerably simplifies the composition header ...

    "ctx/composer_name": "Rebecca Wassall",
    "ctx/health_care_facility|id": "999999-345",
    "ctx/health_care_facility|name": "Northumbria Community NHS",
    "ctx/id_namespace": "NHS-UK",
    "ctx/id_scheme": "2.16.840.1.113883.2.1.4.3",
    "ctx/language": "en",
    "ctx/territory": "GB",
    "ctx/time": "2014-09-23T00:11:02.518+02:00",


###Key openEHR identifiers###

**subjectId/externalId**

The subjectId (sometimes called externalId) is a patient identifier which is known outwith the openEHR system e.g. a hospital identifier or NHS number.

**ehrId**

In an openEHR system, each patient has an ehr (a per-patient electronic health record) with a unique **ehrId** identifier (usually a guid). All references to openEHR patient data are via this ehrId. An API call `GET ehr/` is used to reference the ehrId from the provided subjectId/externalId.

Other subsequent calls to the openEHR system for that particular patient are via the ehrId.

**compositionId**

All openEHR data is committed as one or more compositions, which is then assigned a unique compositionId. If the composition is subsequently updated the root compositionId remain unchanged but its version number is incremented. All previous composition versions are retained.


##HANDI-HOPD Ehrscape primer


TBD


